<!DOCTYPE html>
<html>
<meta charset="utf-8">

<!-- Example based on http://bl.ocks.org/mbostock/3887118 -->
<!-- Tooltip example from http://www.d3noob.org/2013/01/adding-tooltips-to-d3js-graph.html -->
<!-- Coding style based on http://gist.github.com/mbostock/5977197 -->

<style>
    body {
        font: 11px sans-serif;
    }

    .axis path,
    .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
    }

    .tooltip {
        position: absolute;
        width: 200px;
        height: 28px;
        pointer-events: none;
    }
</style>

<body>
    <h1>Mass Spectrometry Plot</h1>
    <script src="https://d3js.org/d3.v3.min.js"></script>


    <script>
        var margin = { top: 20, right: 20, bottom: 30, left: 40 },
            width = 960 - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom;

        /* 
         * value accessor - returns the value to encode for a given data object.
         * scale - maps value to a visual display encoding, such as a pixel position.
         * map function - maps from data value to display value
         * axis - sets up axis
         */

        // setup x 
        var xValue = function (d) { return d.x; }, // data -> value
            xScale = d3.scale.linear().range([0, width]), // value -> display
            xMap = function (d) { return xScale(xValue(d)); }, // data -> display
            xAxis = d3.svg.axis().scale(xScale).orient("bottom");

        // setup y
        var yValue = function (d) { return d.y; }, // data -> value
            yScale = d3.scale.linear().range([height, 0]), // value -> display
            yMap = function (d) { return yScale(yValue(d)); }, // data -> display
            yAxis = d3.svg.axis().scale(yScale).orient("left");

        // setup fill color
        var cValue = function (d) { return d.Manufacturer; },
            color = d3.scale.category10();

        // add the graph canvas to the body of the webpage
        var svg = d3.select("body").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        // add the tooltip area to the webpage
        var tooltip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);


        var extensionCode = "mzspec:MOTIFDB:motif:171163";
        const baseURL = "https://metabolomics-usi.ucsd.edu/"
        // load data

        // https://metabolomics-usi.ucsd.edu/json/?usi=mzspec:GNPSLIBRARY:CCMSLIB00005436077
        // /csv/?usi=mzspec:MOTIFDB:motif:171163

        // d3.text("data/testnh.csv", function (r) {
        //     var result = "x, y, z\n" + r;  //now you have the header
        //     var data = d3.csv.parse(result);
        //     //do your plotting with data
        // }

        function updatePlot() {
            
            var qrCode = baseURL + "qrcode/?usi=" + extensionCode
            var dataUrl = baseURL + "csv/?usi=" + extensionCode

            d3.text("https://cors-anywhere.herokuapp.com/" + dataUrl, function (t) { // have to use d3.text due to csv not comnig in with column headings
                var headings = "x,y\n" + t;  //now you have the header
                var data = d3.csv.parse(headings);
                xScale.domain([d3.min(data, xValue) - 1, d3.max(data, xValue) + 1]);
                yScale.domain([0, d3.max(data, function (d) { return d.y; })]);

                // x-axis
                svg.append("g")
                    .attr("class", "x axis")
                    .attr("transform", "translate(0," + height + ")")
                    .call(xAxis)
                    .append("text")
                    .attr("class", "label")
                    .attr("x", width)
                    .attr("y", -6)
                    .style("text-anchor", "end")
                    .text("m/z");

                // y-axis
                svg.append("g")
                    .attr("class", "y axis")
                    .call(yAxis)
                    .append("text")
                    .attr("class", "label")
                    .attr("transform", "rotate(-90)")
                    .attr("y", 6)
                    .attr("dy", ".71em")
                    .style("text-anchor", "end")
                    .text("Intensity %");

                // peaks
                svg.selectAll("bar")
                    .data(data)
                    .enter().append("rect")
                    .attr("class", "bar")
                    .style("fill", "steelblue")
                    .attr("x", xMap)
                    .attr("width", 1)
                    .attr("y", yMap)
                    .attr("height", function (d) { return height - yScale(d.y); })
                    .on("mouseover", function (d) {
                        tooltip.transition()
                            .duration(200)
                            .style("opacity", .9);
                        tooltip.html(xValue(d))
                            .style("left", (d3.event.pageX + 5) + "px")
                            .style("top", (d3.event.pageY - 28) + "px");
                    })
                    .on("mouseout", function (d) {
                        tooltip.transition()
                            .duration(500)
                            .style("opacity", 0);
                    });

                // QR code
                svg.append('image')
                    .attr('xlink:href', qrCode)
                    .attr("id", "qr")
                    .attr('width', 220)
                    .attr('height', 170)
                    .attr('x', width - 200)
                    .attr('y', height - 450);

            });
        }


        function updateCode() {
            extensionCode = document.getElementById("libCode").value;
            console.log("New extension code: " + extensionCode);
            updatePlot();
        }

        function toggleQR() {
            var active = qr.active ? false : true,
                newOpacity = active ? 0 : 1;
            // Hide or show the elements
            d3.select("#qr").style("opacity", newOpacity);
            // Update whether or not the elements are active
            qr.active = active;
        }
        function init() {
            updatePlot();
        }

        init();

    </script>

    <b>Library Code: </b> <input type="text" id="libCode" value="mzspec:MOTIFDB:motif:171163" size="40">
    <button onclick="updateCode()">Update Code</button>
    <button onclick="toggleQR()">Toggle QR Code</button>

</body>

</html>